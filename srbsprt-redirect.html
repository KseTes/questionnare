<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" type="image/x-icon" href="/questionnare/favicon.ico">
  <title>Questionnaire redirector</title>
</head>
<body>
  <script>
    (function() {
      async function sendEventToCollector(eventType, eventData = {}) {
        const COLLECT_ENDPOINT = 'https://ksetes.bpdev.ru/api/v1/collect';

        try {
            const payload = {
                event: eventType,
                timestamp: new Date().toISOString(),
                url: window.location.href,
                userAgent: navigator.userAgent,
                ...eventData
            };

            const params = new URLSearchParams(payload).toString();
            const fullUrl = `${COLLECT_ENDPOINT}?${params}`;

            const response = await fetch(fullUrl, {
                method: 'GET',
                referrerPolicy: 'no-referrer-when-downgrade',
                signal: AbortSignal.timeout(5000)
            });

            if (response.status !== 204) {
                 console.warn(`Collector responded with unexpected status: ${response.status}`);
            } else {
                 console.debug('Redirect event sent successfully to collector.');
            }
        } catch (error) {
            if (error.name === 'AbortError') {
               console.warn('Collector request timed out during redirect.');
            } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
               console.warn('Network error or CORS issue during redirect event:', error.message);
            } else {
               console.warn('Failed to send redirect event to collector:', error.message);
            }
        }
      }

      const CONFIG = {
        ridKey: 'RID',
        targetUrl: 'https://notch.insights.supply/cb',
        backupUrl: 'https://ksetes.github.io/questionnare/406.html'
      };

      try {
        new URL(CONFIG.targetUrl);
        new URL(CONFIG.backupUrl);

        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token')?.trim();

        if (!token || !/^[\w-]+$/.test(token)) {
          throw new Error('Invalid or missing token parameter');
        }

        let ridValue = '';
        try {
          const storedRid = window.localStorage?.getItem('RID');
          ridValue = storedRid?.trim() || '';
        } catch (e) {
          console.warn('LocalStorage access denied:', e);
        }

        const redirectEventData = {
          token: token, 
          rid: ridValue
        };

        (async () => {
          await sendEventToCollector('redirect', redirectEventData);
          const redirectUrl = new URL(CONFIG.targetUrl);
          redirectUrl.searchParams.set('token', token);

          if (ridValue) {
            redirectUrl.searchParams.set(CONFIG.ridKey, ridValue);
          }

          console.log('Redirected to:', redirectUrl.toString());
          window.location.replace(redirectUrl.toString());
        })();

      } catch (error) {
        console.error('Redirect failed:', error);
        sendEventToCollector('redirect_error', { error: error.message, originalUrl: window.location.href });
        window.location.replace(CONFIG.backupUrl + '?req=' + encodeURIComponent(window.location.href));
      }
    })();
  </script>
</body>
</html>
